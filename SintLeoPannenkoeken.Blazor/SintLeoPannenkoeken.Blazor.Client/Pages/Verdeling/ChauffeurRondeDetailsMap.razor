@page "/verdeling/chauffeurteverdelen/{chauffeurId}/map"
@using SintLeoPannenkoeken.Blazor.Client.Auth
@using SintLeoPannenkoeken.Blazor.Client.Components
@using SintLeoPannenkoeken.Blazor.Client.Server
@using SintLeoPannenkoeken.Blazor.Client.Server.Contracts
@using System.Linq;

<PageTitle>Ronde voorstel</PageTitle>
<h1>Ronde voorstel</h1>

<HeadContent>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="/map.js"></script>
</HeadContent>

<RoleAuthorizedView Roles="@($"{Roles.RolesForRondes}")">
    @foreach (var d in Details?.Details ?? Enumerable.Empty<ChauffeurRondeDetailDto>())
    {
        if (d.Position == null)
        {
            <p>Adres @d.Straat @d.Nummer heeft geen locatiegegevens.</p>
        }
    }

    <div id="map" style="width: 95%; height: 450px; background: grey;">
        <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
    </div>
</RoleAuthorizedView>

@code {
    private int _currentScoutsjaar;
    private IJSObjectReference? _mapModule;


    [Parameter]
    public ChauffeurRondeDetailsDto? Details { get; set; }

    [Parameter]
    public string ChauffeurId { get; set; } = string.Empty;

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;

    [Inject]
    private IServerData _serverData { get; set; } = default!;

    [Inject]
    private CurrentScoutsjaarQuerystringParameterProvider _currentScoutsjaarQuerystringParameterProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var currentScoutsjaar = await _currentScoutsjaarQuerystringParameterProvider.GetCurrentScoutsjaar();
        if (currentScoutsjaar == null)
        {
            return;
        }

        _currentScoutsjaar = currentScoutsjaar.Begin;

        Details = await _serverData.GetChauffeurRondeDetailsRoute(_currentScoutsjaar, int.Parse(ChauffeurId));
        StateHasChanged();
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Details?.Details != null && Details.Details.Any())
        {
            await InitializeMap();
        }
    }

    private async Task InitializeMap()
    {
        var locationsWithPosition = Details!.Details.Where(d => d.Position != null).ToList();

        if (!locationsWithPosition.Any())
        {
            return;
        }

        // Calculate center point (average of all coordinates)
        var centerLat = locationsWithPosition.Average(d => d.Position!.Latitude);
        var centerLng = locationsWithPosition.Average(d => d.Position!.Longitude);

        // Initialize map
        await JSRuntime.InvokeVoidAsync("mapHelper.initMap", "map", centerLat, centerLng, 13);

        // Add markers for each location
        foreach (var detail in locationsWithPosition)
        {
            var popupContent = $"<strong>{detail.Straat} {detail.Nummer}</strong><br/>{detail.AantalPakken} pak(ken)";
            await JSRuntime.InvokeVoidAsync("mapHelper.addMarker",
                detail.Position!.Latitude,
                detail.Position.Longitude,
                popupContent);
        }

        // Fit map bounds to show all markers
        await JSRuntime.InvokeVoidAsync("mapHelper.fitBounds");
    }

    public async ValueTask DisposeAsync()
    {
        if (_mapModule != null)
        {
            await _mapModule.DisposeAsync();
        }
    }
}