@page "/verdeling/chauffeurteverdelen/{chauffeurId}/map"
@using SintLeoPannenkoeken.Blazor.Client.Auth
@using SintLeoPannenkoeken.Blazor.Client.Components
@using SintLeoPannenkoeken.Blazor.Client.Server
@using SintLeoPannenkoeken.Blazor.Client.Server.Contracts
@using System.Linq;

<PageTitle>Ronde voorstel</PageTitle>
<h1>Ronde voorstel</h1>

<HeadContent>
    <link rel="stylesheet" type="text/css" href="https://js.api.here.com/v3/3.2/mapsjs-ui.css" />
    <script type="text/javascript" src='https://heremaps.github.io/maps-api-for-javascript-examples/test-credentials.js'></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.2/mapsjs-core.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.2/mapsjs-service.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.2/mapsjs-ui.js"></script>
    <script type="text/javascript" src="https://js.api.here.com/v3/3.2/mapsjs-mapevents.js"></script>
    <script type="text/javascript" src='/chauffeurRondeDetailsMap.js'></script>
</HeadContent>

<RoleAuthorizedView Roles="@($"{Roles.RolesForRondes}")">
    @foreach (var d in Details?.Details ?? Enumerable.Empty<ChauffeurRondeDetailDto>())
    {
        <div>
            @d.Straat @d.Nummer - @d.AantalPakken pak(ken) - Lat: @d.Position?.Latitude, Lng: @d.Position?.Longitude
        </div>
    }

    <div id="map" style="width: 95%; height: 450px; background: grey;"></div>
</RoleAuthorizedView>

@code {
    private int _currentScoutsjaar;

    [Parameter]
    public ChauffeurRondeDetailsDto? Details { get; set; }

    [Parameter]
    public string ChauffeurId { get; set; } = string.Empty;

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;

    [Inject]
    private IServerData _serverData { get; set; } = default!;

    [Inject]
    private CurrentScoutsjaarQuerystringParameterProvider _currentScoutsjaarQuerystringParameterProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        var currentScoutsjaar = await _currentScoutsjaarQuerystringParameterProvider.GetCurrentScoutsjaar();
        if (currentScoutsjaar == null)
        {
            return;
        }

        _currentScoutsjaar = currentScoutsjaar.Begin;

        Details = await _serverData.GetChauffeurRondeDetailsRoute(_currentScoutsjaar, int.Parse(ChauffeurId));
        StateHasChanged();
        await JSRuntime.InvokeVoidAsync("initHereMap");

        foreach (var detail in Details.Details)
        {
            if (detail.Position == null)
            {
                continue;
            }

            // await JSRuntime.InvokeVoidAsync("addDomMarker", detail.Position?.Latitude, detail.Position?.Longitude);
        }
    }

    // private DotNetObjectReference<ChauffeurRondeDetailsMap>? objRef;
    // private bool scriptLoaded = false;
    // protected override async Task OnAfterRenderAsync(bool firstRender)
    // {
    //     if (firstRender)
    //     {
    //         objRef = DotNetObjectReference.Create(this);
    //         await LoadExternalScript("https://heremaps.github.io/maps-api-for-javascript-examples/test-credentials.js");
    //         await LoadExternalScript("https://js.api.here.com/v3/3.2/mapsjs-core.js");
    //         await LoadExternalScript("https://js.api.here.com/v3/3.2/mapsjs-service.js");
    //         await LoadExternalScript("https://js.api.here.com/v3/3.2/mapsjs-ui.js");
    //         await LoadExternalScript("https://js.api.here.com/v3/3.2/mapsjs-mapevents.js");
    //     }
    // }

    // private async Task LoadExternalScript(string src)
    // {
    //     await JSRuntime.InvokeVoidAsync("eval", $@"
    //         (function() {{
    //             if (!document.querySelector('script[src=""{src}""]')) {{
    //                 const script = document.createElement('script');
    //                 script.src = '{src}';
    //                 script.onload = () => console.log('Script loaded');
    //                 document.head.appendChild(script);
    //             }}
    //         }})();
    //     ");

    //     // Wait a bit for script to load
    //     await Task.Delay(500);
    //     scriptLoaded = true;
    // }
}