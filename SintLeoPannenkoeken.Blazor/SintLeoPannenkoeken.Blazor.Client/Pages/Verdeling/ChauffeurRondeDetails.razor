@page "/verdeling/chauffeurteverdelen/{chauffeurId}"
@using SintLeoPannenkoeken.Blazor.Client.Auth
@using SintLeoPannenkoeken.Blazor.Client.Components
@using SintLeoPannenkoeken.Blazor.Client.Server
@using SintLeoPannenkoeken.Blazor.Client.Server.Contracts
@using System.Linq;

<PageTitle>Ronde voorstel</PageTitle>

<HeadContent>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
          crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <script src="/map.js"></script>
</HeadContent>

<MasterDetailPage TDto="ChauffeurRondeDetailDto"
                  AuthorizedRoles="@($"{Roles.RolesForRondes}")"
                  Title="@($"Adressen voor {Details?.ChauffeurNaam}")"
                  DataProvider="@GetDetails"
                  CanAdd="false"
                  CanEdit="false"
                  CanDelete="false"
                  IsForScoutsjaar="true">
    <ContentBeforeData>
        @foreach (var d in Details?.Details ?? Enumerable.Empty<ChauffeurRondeDetailDto>())
        {
            if (d.Position == null)
            {
                <p>Adres @d.Straat @d.Nummer heeft geen locatiegegevens.</p>
            }
        }

        @if (_isLoading)
        {
            <MudGrid Justify="Justify.Center" Class="mt-10">
                <MudProgressCircular Indeterminate="true" Color="Color.Primary" Size="Size.Large" />
            </MudGrid>
        }

        @if (!_isLoading && (!Details?.Details?.Any() ?? true))
        {
            <p>Deze chauffeur heeft nog geen rondes toegewezen gekregen, of de rondes bevatten nog geen bestellingen.</p>
        }

        <div id="map" class="mt-4" style="width: 95%; height: 450px; background: grey; display: none;">
        </div>
    </ContentBeforeData>
    <Columns>
        <PropertyColumn T="ChauffeurRondeDetailDto" TProperty="string" Property="x => x.ZoneNaam" Title="Zone" InitialDirection="SortDirection.Ascending" />
        <PropertyColumn T="ChauffeurRondeDetailDto" TProperty="string" Property="x => x.Straat" Title="Straat" InitialDirection="SortDirection.Ascending" />
        <PropertyColumn T="ChauffeurRondeDetailDto" TProperty="string" Property="x => x.Nummer" Title="Nummer" />
        <PropertyColumn T="ChauffeurRondeDetailDto" TProperty="string" Property="x => x.Bus" Title="Bus" />
        <PropertyColumn T="ChauffeurRondeDetailDto" TProperty="string" Property="x => x.Naam" Title="Naam" />
        <PropertyColumn T="ChauffeurRondeDetailDto" TProperty="int" Property="x => x.AantalPakken" Title="Aantal" />
    </Columns>
</MasterDetailPage>

@code {
    private int _currentScoutsjaar;
    private IJSObjectReference? _mapModule;
    private bool _isLoading = true;


    [Parameter]
    public ChauffeurRondeDetailsDto? Details { get; set; }

    [Parameter]
    public string ChauffeurId { get; set; } = string.Empty;

    [Inject]
    public IJSRuntime JSRuntime { get; set; } = default!;

    [Inject]
    private IServerData _serverData { get; set; } = default!;

    [Inject]
    private CurrentScoutsjaarQuerystringParameterProvider _currentScoutsjaarQuerystringParameterProvider { get; set; } = default!;

    private async Task<IList<ChauffeurRondeDetailDto>> GetDetails(IServerData serverData)
    {
        var scoutsjaar = await _currentScoutsjaarQuerystringParameterProvider.GetCurrentScoutsjaar();
        if (scoutsjaar == null)
        {
            return new List<ChauffeurRondeDetailDto>();
        }

        _currentScoutsjaar = scoutsjaar.Begin;
        _isLoading = true;
        Details = await serverData.GetChauffeurRondeDetails(_currentScoutsjaar, int.Parse(ChauffeurId));
        _isLoading = false;
        StateHasChanged();
        return Details.Details;
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (Details?.Details != null && Details.Details.Any())
        {
            await InitializeMap();
        }
    }

    private async Task InitializeMap()
    {
        var locationsWithPosition = Details!.Details.Where(d => d.Position != null).ToList();

        if (!locationsWithPosition.Any())
        {
            return;
        }

        // Calculate center point (average of all coordinates)
        var centerLat = locationsWithPosition.Average(d => d.Position!.Latitude);
        var centerLng = locationsWithPosition.Average(d => d.Position!.Longitude);

        // Initialize map
        await JSRuntime.InvokeVoidAsync("mapHelper.initMap", "map", centerLat, centerLng, 13);

        // Add markers for each location
        foreach (var detail in locationsWithPosition)
        {
            var popupContent = $"<strong>{detail.Straat} {detail.Nummer}</strong><br/>{detail.AantalPakken} pak(ken)";
            await JSRuntime.InvokeVoidAsync("mapHelper.addMarker",
                detail.Position!.Latitude,
                detail.Position.Longitude,
                popupContent);
        }

        // Fit map bounds to show all markers
        await JSRuntime.InvokeVoidAsync("mapHelper.fitBounds");
    }

    public async ValueTask DisposeAsync()
    {
        if (_mapModule != null)
        {
            await _mapModule.DisposeAsync();
        }
    }
}