@page "/verkoop/bestellingen"
@using SintLeoPannenkoeken.Blazor.Client.Auth
@using SintLeoPannenkoeken.Blazor.Client.Components
@using SintLeoPannenkoeken.Blazor.Client.Server
@using SintLeoPannenkoeken.Blazor.Client.Server.Contracts
@using System.Linq;

<MasterDetailPage TDto="BestellingDto"
                  AuthorizedRoles="@($"{Roles.RolesForBestellingen}")"
                  Title="Bestellingen"
                  DataProvider="@GetBestellingen"
                  OnUpdate="@OnUpdate"
                  OnCancel="@OnCancel"
                  OnCreate="@OnCreate"
                  OnDelete="@OnDelete"
                  CanEdit="false"
                  CanDelete="true"
                  IsForScoutsjaar="true"
                  NewItemTitle="Nieuwe bestelling"
                  NewItemExpanded="true">
    <NewItemFormElements>
        <BestellingForm @ref="bestellingForm" />
    </NewItemFormElements>
    
    <Columns>
        <PropertyColumn T="BestellingDto" TProperty="int" Property="x => x.BestellingNummer" Title="Nr" InitialDirection="SortDirection.Descending" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Naam" Title="Koper" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Telefoon" Title="Telefoon" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => FormatCode(x)" Title="Code" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => FormatAdres(x)" Title="Adres" /> 
        <PropertyColumn T="BestellingDto" TProperty="int" Property="x => x.AantalPakken" Title="Aantal pakken" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Opmerkingen" Title="Opmerkingen" />
        <TemplateColumn T="BestellingDto" Title="Betaald">
            <CellTemplate>
                <BooleanIcon T="BestellingDto" Value="@context.Item.Betaald" />
            </CellTemplate>
        </TemplateColumn>
        <TemplateColumn T="BestellingDto" Title="Geleverd">
            <CellTemplate>
                <BooleanIcon T="BestellingDto" Value="@context.Item.Geleverd" />
            </CellTemplate>
        </TemplateColumn>
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.LidNaam" Title="Lid" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.TakNaam" Title="Tak" />
    </Columns>
</MasterDetailPage>

@code {
    private async Task<IList<BestellingDto>> GetBestellingen(IServerData serverData)
    {
        var scoutsjaar = await CurrentScoutsjaarQuerystringParameterProvider.GetCurrentScoutsjaar();
        var result = await serverData.GetBestellingen(scoutsjaar.Begin);
        return result;
    }

    [Inject]
    private IServerData _serverData { get; set; } = default!;

    [Inject]
    public CurrentScoutsjaarQuerystringParameterProvider CurrentScoutsjaarQuerystringParameterProvider { get; set; } = default!;

    private BestellingForm bestellingForm = default!;

    async Task<BestellingDto> OnCreate()
    {
        var newBestellingDto = new NewBestellingDto
        {
            Naam = bestellingForm.Naam ?? "",
            Telefoon = bestellingForm.Telefoon,
            StraatId = bestellingForm.Straat?.Id ?? 0,
            Nummer = bestellingForm.Nummer,
            Bus = bestellingForm.Bus,
            AantalPakken = bestellingForm.AantalPakken ?? 0,
            Betaald = bestellingForm.Betaald,
            Geleverd = bestellingForm.Geleverd,
            Opmerkingen = bestellingForm.Opmerkingen,
            LidId = bestellingForm.Lid?.Id ?? 0,
            ScoutsjaarId = (await CurrentScoutsjaarQuerystringParameterProvider.GetCurrentScoutsjaar())!.Id!.Value
        };

        var result = await _serverData.CreateBestelling(newBestellingDto);
        OnCancel();
        return result;
    }

    void OnCancel()
    {
        bestellingForm.Naam = null;
        bestellingForm.Telefoon = null;
        bestellingForm.Straat = null;
        bestellingForm.Nummer = null;
        bestellingForm.Bus = null;
        bestellingForm.AantalPakken = null;
        bestellingForm.Betaald = true;
        bestellingForm.Geleverd = false;
        bestellingForm.Opmerkingen = null;
        bestellingForm.Lid = null;
        bestellingForm.ZelfAfhalen = false;
    }

    async Task OnUpdate(BestellingDto item)
    {
        var updateBestellingDto = new UpdateBestellingDto
        {
            Id = item.Id,
            Naam = item.Naam,
            Telefoon = item.Telefoon,
            AantalPakken = item.AantalPakken,
            Opmerkingen = item.Opmerkingen,
            Betaald = item.Betaald,
            Geleverd = item.Geleverd,
            LidId = item.Lid?.Id ?? 0,
            StraatId = item.StraatId,
            Nummer = item.Nummer,
            Bus = item.Bus
        };

        await _serverData.UpdateBestelling(updateBestellingDto);
    }

    async Task OnDelete(BestellingDto item)
    {
        await _serverData.DeleteBestelling(item.Id);
    }

    private string FormatAdres(BestellingDto bestelling)
    {
        var adres = $"{bestelling.StraatNaam} {bestelling.Nummer}";
        if (!string.IsNullOrWhiteSpace(bestelling.Bus))
        {
            adres += $"/bus {bestelling.Bus}";
        }
        return adres;
    }

    private string FormatCode(BestellingDto bestelling)
    {
        return $"{bestelling.ZoneNaam} {bestelling.StraatNummer}";
    }
}