@page "/verkoop/bestellingen"
@using SintLeoPannenkoeken.Blazor.Client.Auth
@using SintLeoPannenkoeken.Blazor.Client.Components
@using SintLeoPannenkoeken.Blazor.Client.Server
@using SintLeoPannenkoeken.Blazor.Client.Server.Contracts
@using System.Linq;

<MasterDetailPage TDto="BestellingDto"
                  AuthorizedRoles="@($"{Roles.RolesForBestellingen}")"
                  Title="Bestellingen"
                  DataProvider="@GetBestellingen"
                  OnUpdate="@OnUpdate"
                  OnCancel="@OnCancel"
                  OnCreate="@OnCreate"
                  OnDelete="@OnDelete"
                  OnEdit="@OnEdit"
                  CanEdit="true"
                  CanDelete="true"
                  IsForScoutsjaar="true"
                  NewItemTitle="Nieuwe bestelling"
                  NewItemExpanded="true">
    <NewItemFormElements>
        <BestellingForm @ref="bestellingForm" />
    </NewItemFormElements>
    
    <Columns>
        <PropertyColumn T="BestellingDto" TProperty="int" Property="x => x.BestellingNummer" Title="Nr" InitialDirection="SortDirection.Descending" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Naam" Title="Koper" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Telefoon" Title="Telefoon" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => FormatCode(x)" Title="Code" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => FormatAdres(x)" Title="Adres" /> 
        <PropertyColumn T="BestellingDto" TProperty="int" Property="x => x.AantalPakken" Title="Aantal pakken" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Opmerkingen" Title="Opmerkingen" />
        <PropertyColumn T="BestellingDto" TProperty="bool" Property="x => x.Betaald" Title="Betaald">
            <CellTemplate>
                <BooleanIcon T="BestellingDto" Value="@context.Item.Betaald" />
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn T="BestellingDto" TProperty="bool" Property="x => x.Geleverd" Title="Geleverd">
            <CellTemplate>
                <BooleanIcon T="BestellingDto" Value="@context.Item.Geleverd" />
            </CellTemplate>
        </PropertyColumn>
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.LidNaam" Title="Lid" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.TakNaam" Title="Tak" />
    </Columns>
</MasterDetailPage>

@code {
    private async Task<IList<BestellingDto>> GetBestellingen(IServerData serverData)
    {
        var scoutsjaar = await CurrentScoutsjaarQuerystringParameterProvider.GetCurrentScoutsjaar();
        var result = await serverData.GetBestellingen(scoutsjaar.Begin);
        return result;
    }

    [Inject]
    private IServerData _serverData { get; set; } = default!;

    [Inject]
    private IDialogService _dialogService { get; set; } = default!;

    [Inject]
    private ISnackbar _snackbar { get; set; } = default!;

    [Inject]
    public CurrentScoutsjaarQuerystringParameterProvider CurrentScoutsjaarQuerystringParameterProvider { get; set; } = default!;

    private BestellingForm bestellingForm = default!;

    async Task<BestellingDto> OnCreate()
    {
        var newBestellingDto = new NewBestellingDto
        {
            Naam = bestellingForm.Item.Naam ?? "",
            Telefoon = bestellingForm.Item.Telefoon,
            StraatId = bestellingForm.Item.Straat?.Id ?? 0,
            Nummer = bestellingForm.Item.Nummer,
            Bus = bestellingForm.Item.Bus,
            AantalPakken = bestellingForm.Item.AantalPakken,
            Betaald = bestellingForm.Item.Betaald,
            Geleverd = bestellingForm.Item.Geleverd,
            Opmerkingen = bestellingForm.Item.Opmerkingen,
            LidId = bestellingForm.Item.Lid?.Id ?? 0,
            ScoutsjaarId = (await CurrentScoutsjaarQuerystringParameterProvider.GetCurrentScoutsjaar())!.Id!.Value
        };

        var result = await _serverData.CreateBestelling(newBestellingDto);
        OnCancel();
        return result;
    }

    void OnCancel()
    {
        bestellingForm.Reset();
    }

    async Task OnUpdate(BestellingDto item)
    {
        var updateBestellingDto = new UpdateBestellingDto
        {
            Id = item.Id,
            Naam = item.Naam,
            Telefoon = item.Telefoon,
            AantalPakken = item.AantalPakken,
            Opmerkingen = item.Opmerkingen,
            Betaald = item.Betaald,
            Geleverd = item.Geleverd,
            LidId = item.Lid?.Id ?? 0,
            StraatId = item.Straat?.Id ?? 0,
            Nummer = item.Nummer,
            Bus = item.Bus
        };

        await _serverData.UpdateBestelling(updateBestellingDto);
    }

    async Task OnEdit(BestellingDto item)
    {
        var options = new DialogOptions
        {
            CloseOnEscapeKey = true,
            CloseButton = true,
        };

        var parameters = new DialogParameters<BestellingDialog>
        {
            { x => x.Item, item }
        };

        var dialog = await _dialogService.ShowAsync<BestellingDialog>("Bewerken", parameters, options);
        var result = await dialog.Result;
        if (!result.Canceled)
        {
            try
            {
                await OnUpdate(item);
                _snackbar.Add("De gegevens werden succesvol bijgewerkt.", Severity.Success);
            }
            catch (Exception e)
            {
                _snackbar.Add($"Er is een fout gebeurd: {e.Message}", Severity.Error);
            }
        }
    }

    async Task OnDelete(BestellingDto item)
    {
        await _serverData.DeleteBestelling(item.Id);
    }

    private string FormatAdres(BestellingDto bestelling)
    {
        var adres = $"{bestelling.StraatNaam} {bestelling.Nummer}";
        if (!string.IsNullOrWhiteSpace(bestelling.Bus))
        {
            adres += $"/bus {bestelling.Bus}";
        }
        return adres;
    }

    private string FormatCode(BestellingDto bestelling)
    {
        return $"{bestelling.Straat?.ZoneNaam} {bestelling.Straat?.Nummer}";
    }
}