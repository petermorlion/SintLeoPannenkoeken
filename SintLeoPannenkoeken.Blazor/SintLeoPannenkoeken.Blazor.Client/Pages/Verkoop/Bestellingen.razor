@page "/bestellingen"
@using SintLeoPannenkoeken.Blazor.Client.Auth
@using SintLeoPannenkoeken.Blazor.Client.Server
@using SintLeoPannenkoeken.Blazor.Client.Server.Contracts

<MasterDetailPage TDto="BestellingDto"
                  AuthorizedRoles="@($"{Roles.RolesForBestellingen}")"
                  Title="Bestellingen"
                  DataProvider="@_dataProvider"
                  OnUpdate="@OnUpdate"
                  CanEdit="false">
    <ContentBeforeData>
        <MudExpansionPanels>
            <MudExpansionPanel Text="Nieuwe bestelling" Expanded="true">
                <MudForm>
                    <MudGrid>
                        <MudItem xs="12" sm="8">
                            <MudTextField T="string" Label="Naam koper" Required="true" RequiredError="Naam koper is verplicht." Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>
                        <MudItem xs="12" sm="4">
                            <MudTextField T="string" Label="Telefoon" Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>

                        <MudItem xs="12" sm="2">
                            <MudCheckBox T="bool" Label="Zelf afhalen" />
                        </MudItem>
                        <MudItem xs="12" sm="5">
                            <MudSelect T="int" Label="Straat" Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>
                        <MudItem xs="12" sm="2">
                            <MudTextField T="string" Label="Code" Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>
                        <MudItem xs="12" sm="2">
                            <MudTextField T="string" Label="Nummer" Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>
                        <MudItem xs="12" sm="1">
                            <MudTextField T="string" Label="Bus" Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>

                        <MudItem xs="12" sm="2">
                            <MudNumericField T="int" Label="Aantal pakken" Min="0" Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>
                        <MudItem xs="12" sm="2">
                            <MudCheckBox T="bool" Label="Betaald" />
                        </MudItem>
                        <MudItem xs="12" sm="2">
                            <MudCheckBox T="bool" Label="Geleverd" />
                        </MudItem>
                        <MudItem xs="12" sm="6">
                            <MudTextField T="string" Label="Opmerkingen" Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>

                        <MudItem xs="12">
                            <MudSelect T="int" Label="Lid" Variant="Variant.Outlined" Margin="Margin.Dense" ShrinkLabel />
                        </MudItem>
                        <MudItem xs="12">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary">Opslaan</MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Secondary">Annuleren</MudButton>
                        </MudItem>
                    </MudGrid>
                </MudForm>
            </MudExpansionPanel>
        </MudExpansionPanels>
    </ContentBeforeData>
    <Columns>
        <PropertyColumn T="BestellingDto" TProperty="int" Property="x => x.BestellingNummer" Title="Nr" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Naam" Title="Koper" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Telefoon" Title="Telefoon" />
        @* <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x." Title="Code" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x." Title="Adres" /> *@
        <PropertyColumn T="BestellingDto" TProperty="int" Property="x => x.AantalPakken" Title="Aantal pakken" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.Opmerkingen" Title="Opmerkingen" />
        @* <PropertyColumn T="BestellingDto" TProperty="bool" Property="x => x.Betaald" Title="Betaald" />
        <PropertyColumn T="BestellingDto" TProperty="bool" Property="x => x.Geleverd" Title="Geleverd" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.LidNaam" Title="Lid" />
        <PropertyColumn T="BestellingDto" TProperty="string" Property="x => x.TakNaam" Title="Tak" /> *@
    </Columns>
</MasterDetailPage>

@code {
    private Func<IServerData, Task<IEnumerable<BestellingDto>>> _dataProvider => async (serverData) => await serverData.GetBestellingen(2025);

    [Inject]
    private IServerData _serverData { get; set; } = default!;

    async Task OnUpdate(BestellingDto item)
    {
        var updateBestellingDto = new UpdateBestellingDto
        {
            Id = item.Id,
            Naam = item.Naam,
            Telefoon = item.Telefoon,
            AantalPakken = item.AantalPakken,
            Opmerkingen = item.Opmerkingen,
            Betaald = item.Betaald,
            Geleverd = item.Geleverd,
            LidId = item.Lid?.Id ?? 0,
            StraatId = item.StraatId,
            Nummer = item.Nummer,
            Bus = item.Bus
        };

        await _serverData.UpdateBestelling(updateBestellingDto);
    }
}

