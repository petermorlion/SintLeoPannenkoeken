@using SintLeoPannenkoeken.Blazor.Client.Auth
@using SintLeoPannenkoeken.Blazor.Client.Pages
@using Microsoft.AspNetCore.Components.Routing

<NavLink ActiveClass="d-flex align-center me-4" href="/">
    <img src="zeescouts.svg" style="max-height: 50px; color:#fff" />
</NavLink>
<AuthorizeView Roles="@($"{Roles.RolesForBestellingen}")" Context="childContext">
    <NavMenuItem Href="@($"{Hrefs.Bestellingen}?scoutsjaar={_currentScoutsjaarQuerystringValue}")" Text="Bestellingen" ActiveClass="@GetActiveClass(Hrefs.Bestellingen)" />
</AuthorizeView>
<AuthorizeView Roles="@($"{Roles.RolesForChauffeurs}")" Context="childContext">
    <NavMenuItem Href="@($"{Hrefs.Chauffeurs}?scoutsjaar={_currentScoutsjaarQuerystringValue}")" Text="Chauffeurs" ActiveClass="@GetActiveClass(Hrefs.Chauffeurs)" />
</AuthorizeView>
<AuthorizeView Roles="@($"{Roles.RolesForChauffeurs}")" Context="childContext">
    <NavMenuItem Href="@($"{Hrefs.Rondes}?scoutsjaar={_currentScoutsjaarQuerystringValue}")" Text="Rondes" ActiveClass="@GetActiveClass(Hrefs.Rondes)" />
</AuthorizeView>
<AuthorizeView Roles="@($"{Roles.RolesForStreefcijfers}")" Context="childContext">
    <NavMenuItem Href="@($"{Hrefs.Streefcijfers}?scoutsjaar={_currentScoutsjaarQuerystringValue}")" Text="Streefcijfers" ActiveClass="@GetActiveClass(Hrefs.Streefcijfers)" />
</AuthorizeView>

<MudMenu Label="Rapporten" Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.KeyboardArrowDown" Class="d-none d-md-flex mx-1 px-3">
    <MudNavLink Href="@($"{Hrefs.VerkoopPerTak}?scoutsjaar={_currentScoutsjaarQuerystringValue}")">Verkoop per tak</MudNavLink>
    <MudNavLink Href="@($"{Hrefs.VerkoopPerLid}?scoutsjaar={_currentScoutsjaarQuerystringValue}")">Verkoop per lid</MudNavLink>
    <MudNavLink Href="@($"{Hrefs.IngegevenTotalen}?scoutsjaar={_currentScoutsjaarQuerystringValue}")">Totaal ingegeven</MudNavLink>
</MudMenu>
<MudNavGroup Title="Rapporten" Class="d-flex d-md-none">
    <MudNavLink Href="@($"{Hrefs.VerkoopPerTak}?scoutsjaar={_currentScoutsjaarQuerystringValue}")">Verkoop per tak</MudNavLink>
    <MudNavLink Href="@($"{Hrefs.VerkoopPerLid}?scoutsjaar={_currentScoutsjaarQuerystringValue}")">Verkoop per lid</MudNavLink>
    <MudNavLink Href="@($"{Hrefs.IngegevenTotalen}?scoutsjaar={_currentScoutsjaarQuerystringValue}")">Totaal ingegeven</MudNavLink>
</MudNavGroup>

<AuthorizeView Roles="@($"{Roles.RolesForBeheer}")">
    <Authorized>
        <MudMenu Label="Beheer" Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.KeyboardArrowDown" Class="d-none d-md-flex mx-1 px-3">
            <AuthorizeView Roles="@($"{Roles.RolesForGebruikers}")" Context="childContext">
                <MudNavLink Href="@Hrefs.Gebruikers">Gebruikers</MudNavLink>
            </AuthorizeView>
            <AuthorizeView Roles="@($"{Roles.RolesForLeden}")" Context="childContext">
                <MudNavLink Href="@Hrefs.Leden">Leden</MudNavLink>
            </AuthorizeView>
            <AuthorizeView Roles="@($"{Roles.RolesForScoutsjaren}")" Context="childContext">
                <MudNavLink Href="@Hrefs.Scoutsjaren">Scoutsjaren</MudNavLink>
            </AuthorizeView>
            <AuthorizeView Roles="@($"{Roles.RolesForStraten}")" Context="childContext">
                <MudNavLink Href="@Hrefs.Straten">Straten</MudNavLink>
            </AuthorizeView>
        </MudMenu>
        <MudNavGroup Title="Beheer" Class="d-flex d-md-none">
            <AuthorizeView Roles="@($"{Roles.RolesForGebruikers}")" Context="childContext">
                <MudNavLink Href="@Hrefs.Gebruikers">Gebruikers</MudNavLink>
            </AuthorizeView>
            <AuthorizeView Roles="@($"{Roles.RolesForLeden}")" Context="childContext">
                <MudNavLink Href="@Hrefs.Leden">Leden</MudNavLink>
            </AuthorizeView>
            <AuthorizeView Roles="@($"{Roles.RolesForScoutsjaren}")" Context="childContext">
                <MudNavLink Href="@Hrefs.Scoutsjaren">Scoutsjaren</MudNavLink>
            </AuthorizeView>
            <AuthorizeView Roles="@($"{Roles.RolesForStraten}")" Context="childContext">
                <MudNavLink Href="@Hrefs.Straten">Straten</MudNavLink>
            </AuthorizeView>
        </MudNavGroup>
    </Authorized>
</AuthorizeView>

<MudSpacer />

<AuthorizeView>
    <Authorized>
        <MudIconButton Href="@Hrefs.Account"
                       Icon="@Icons.Material.Filled.AccountCircle" />
    </Authorized>
    <NotAuthorized>
        <MudButton Href="@Hrefs.Login"
                   Variant="Variant.Filled"
                   Color="Color.Secondary">
            Login
        </MudButton>
    </NotAuthorized>
</AuthorizeView>



@code {
    private int? _currentScoutsjaarQuerystringValue;
    private bool _drawerOpen = false;

    [Inject]
    public NavigationManager NavigationManager { get; set; } = default!;

    [Inject]
    private CurrentScoutsjaarQuerystringParameterProvider _currentScoutsjaarQuerystringParameterProvider { get; set; } = default!;

    protected override async Task OnInitializedAsync()
    {
        NavigationManager.LocationChanged += OnLocationChanged;
        var currentScoutsjaar = await _currentScoutsjaarQuerystringParameterProvider.GetCurrentScoutsjaar();
        if (currentScoutsjaar != null)
        {
            _currentScoutsjaarQuerystringValue = currentScoutsjaar.Begin;
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        InvokeAsync(StateHasChanged);
    }

    private string GetActiveClass(string href)
    {
        var current = NavigationManager.ToBaseRelativePath(NavigationManager.Uri).Split('?')[0].Trim('/');
        var target = (href ?? string.Empty).Trim('/');

        if (string.Equals(current, target, StringComparison.OrdinalIgnoreCase))
        {
            return "mud-chip-text mud-chip-color-primary mx-1 px-3";
        }

        return "mx-1 px-3";
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }
}
